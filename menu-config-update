#!/bin/bash

export LANG=$LANG:C
if [[ "$USER" == "root" ]]; then
	:;
else
	if [[ `command -v sudo` ]]; then
		if [[ $EUID -ne 0 ]]; then
			sudo "$0" "$@"
			exit
		fi
	else
		echo "Please run this as root or with sudo privileges."
		exit 1
	fi
fi
if [[ `curl -I https://github.com 2>&1 | grep 'HTTP/2 200'` ]]; then
	:;
else
	echo -e "The script requires an internet connection."
	read -p "Enter to continue"
	exit 1
fi

clear -x
echo -en "Updating menu"
git clone -q https://github.com/pyavitz/rpi-img-builder.git -b menuconfig /tmp/menuconfig
if [[ -f "/tmp/menuconfig/menu-config" ]] && [[ `type -p menu-config` ]]; then
	sudo mv -f /usr/local/bin/menu-config /usr/local/bin/menu-config.orig
	sudo cp /tmp/menuconfig/menu-config /usr/local/bin/menu-config
	sudo chmod +x $(command -v menu-config)
else
	rm -fdr /tmp/menuconfig
	read -p " [failed]"
	exit 1
fi
echo -en " [checking]"
if [[ `type -p menu-config` ]] && [[ -f "/usr/local/bin/menu-config.orig" ]]; then
	sleep 1
	sudo rm -f /usr/local/bin/menu-config.orig
	rm -fdr /tmp/menuconfig
	echo -e " [done]"
	sleep 1.25
else
	sudo mv -f /usr/local/bin/menu-config.orig /usr/local/bin/menu-config
	rm -fdr /tmp/menuconfig
	read -p " [failed]"
fi
clear -x
menu-config

exit 0
